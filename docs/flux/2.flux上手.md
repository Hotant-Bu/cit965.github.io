---
sidebar_label: 2.flux上手
sidebar_position: 1
title: 2.flux上手
---

# Flux 教程：在 Kubernetes 集群上引导 Flux 并部署示例应用程序

本教程将向您展示如何将 Flux 引导到 Kubernetes 集群，并以 GitOps 方式部署一个示例应用程序。

## 开始之前

要遵循这个指南，你需要以下内容：

- 一个 Kubernetes 集群。我们推荐 Kubernetes kind，用于在本地开发环境中试用 Flux。
- 具有 repo 权限的 GitHub 个人访问令牌。参阅 GitHub 文档，了解如何创建个人访问令牌。

## 目标

- 在 Kubernetes 集群上引导 Flux。
- 使用 Flux 部署一个示例应用程序。
- 通过 Kustomize patches 自定义应用程序配置。

## 安装 Flux CLI

Flux 命令行接口 (CLI) 用于引导和与 Flux 交互。

要使用 Homebrew 安装 CLI，请运行：

```bash
brew install fluxcd/tap/flux
```

## 导出凭据
导出您的GitHub个人访问令牌和用户名：

```shell

export GITHUB_TOKEN=<您的令牌>
export GITHUB_USER=<您的用户名>
```



## 检查您的Kubernetes集群
通过运行以下命令检查是否具备运行Flux所需的所有条件：

```shell

flux check --pre
```



## 安装Flux到您的集群
有关如何使用GitHub组织、GitLab和其他Git提供程序进行引导的信息，请参阅安装文档。

运行引导命令：

```shell

flux bootstrap github \
  --owner=$GITHUB_USER \
  --repository=fleet-infra \
  --branch=main \
  --path=./clusters/my-cluster \
  --personal
```



## 克隆git仓库
将fleet-infra仓库克隆到本地机器上：

```shell

git clone https://github.com/$GITHUB_USER/fleet-infra
cd fleet-infra
```



## 将podinfo仓库添加到Flux中
此示例使用一个公共仓库github.com/stefanprodan/podinfo，podinfo是一个使用Go创建的小型Web应用程序。

创建一个GitRepository清单，指向podinfo仓库的主分支：

```shell

flux create source git podinfo \
  --url=https://github.com/stefanprodan/podinfo \
  --branch=master \
  --interval=30s \
  --export > ./clusters/my-cluster/podinfo-source.yaml
```



提交并推送podinfo-source.yaml文件到fleet-infra仓库：

```shell
git add -A && git commit -m "Add podinfo GitRepository"
git push
```



## 部署podinfo应用程序
配置Flux构建并应用位于podinfo仓库中的kustomize目录。

使用flux create命令创建一个Kustomization来应用podinfo部署：

```shell

flux create kustomization podinfo \
  --target-namespace=default \
  --source=podinfo \
  --path="./kustomize" \
  --prune=true \
  --interval=5m \
  --export > ./clusters/my-cluster/podinfo-kustomization.yaml
```



提交并推送Kustomization清单到仓库：

```shell

git add -A && git commit -m "Add podinfo Kustomization"
git push
```



fleet-infra仓库的结构应类似于：

```perl

fleet-infra
└── clusters/
    └── my-cluster/
        ├── flux-system/
        │   ├── gotk-components.yaml
        │   ├── gotk-sync.yaml
        │   └── kustomization.yaml
        ├── podinfo-kustomization.yaml
        └── podinfo-source.yaml
```



## 监视Flux同步应用程序
使用flux get命令监视podinfo应用程序：

```shell
flux get kustomizations --watch
```



检查podinfo是否已部署到您的集群：

```shell
kubectl -n default get deployments,services
```



## 暂停更新
暂停kustomization的更新允许您直接编辑从kustomization应用的对象，而不会受到Git中的状态回滚影响。

要暂停kustomization的更新，运行以下命令：

```shell
flux suspend kustomization <name>
```



要恢复更新，运行以下命令：

```shell
flux resume kustomization <name>
```



## 自定义podinfo部署
要自定义不受您控制的仓库中的部署，您可以使用Flux的内联补丁（inline patches）。下面的示例展示了如何使用内联补丁来更改podinfo部署。

在podinfo-kustomization.yaml文件的spec字段中添加以下内容：

```yaml
patches:
  - patch: |-
      apiVersion: autoscaling/v2beta2
      kind: HorizontalPodAutoscaler
      metadata:
        name: podinfo
      spec:
        minReplicas: 3             
    target:
      name: podinfo
      kind: HorizontalPodAutoscaler
```



提交并推送podinfo-kustomization.yaml文件的更改：

```shell
git add -A && git commit -m "Increase podinfo minimum replicas"
git push
```



同步完成后，运行`kubectl get pods`命令应显示3个Pod。

## 多集群设置
如果要使用Flux管理多个集群或从Staging环境推广部署到Production环境，请参考下面列出的两种方法： 
- [flux2-kustomize-helm-example](https://github.com/fluxcd/flux2-kustomize-helm-example) 
- [flux2-multi-tenancy](https://github.com/fluxcd/flux2-multi-tenancy)
